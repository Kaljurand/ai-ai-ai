<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estonian Speech Comparison Tool</title>
  <!-- React and Babel from CDN for simplicity -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    textarea { width: 100%; height: 6rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.25rem; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Helper: compute Word Error Rate
    function wordErrorRate(ref, hyp) {
      const r = ref.split(/\s+/);
      const h = hyp.split(/\s+/);
      const dp = Array.from({ length: r.length + 1 }, () => Array(h.length + 1).fill(0));
      for (let i = 0; i <= r.length; i++) dp[i][0] = i;
      for (let j = 0; j <= h.length; j++) dp[0][j] = j;
      for (let i = 1; i <= r.length; i++) {
        for (let j = 1; j <= h.length; j++) {
          const cost = r[i - 1] === h[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return (dp[r.length][h.length] / r.length).toFixed(2);
    }

    // Load/save from localStorage
    function useStoredState(key, initial) {
      const [state, setState] = useState(() => {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : initial;
      });
      useEffect(() => {
        localStorage.setItem(key, JSON.stringify(state));
      }, [key, state]);
      return [state, setState];
    }

    function App() {
      const [apiKeys, setApiKeys] = useStoredState('apiKeys', { openai: '' });
      const [texts, setTexts] = useStoredState('texts', []);
      const [audios, setAudios] = useStoredState('audios', []);
      const [transcripts, setTranscripts] = useStoredState('transcripts', []);
      const [inputText, setInputText] = useState('');

      const mockMode = !apiKeys.openai;

      const generateText = async () => {
        if (mockMode) {
          const mock = `Näidis lause ${texts.length + 1} numbriga ${Math.floor(Math.random()*100)}`;
          setTexts([...texts, { provider: 'mock', text: mock }]);
          return;
        }
        const prompt = 'Loo keeruline lühike eestikeelne tekst, mis sisaldab numbreid ja lühendeid.';
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKeys.openai}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }]
          })
        }).then(r => r.json());
        const text = res.choices?.[0]?.message?.content?.trim();
        if (text) setTexts([...texts, { provider: 'openai', text }]);
      };

      const synthesize = async (index) => {
        const txt = texts[index];
        if (!txt) return;
        if (mockMode) {
          const blob = new Blob([txt.text], { type: 'audio/plain' });
          const url = URL.createObjectURL(blob);
          setAudios([...audios, { index, provider: 'mock', url }]);
          return;
        }
        // Fallback to Web Speech API
        const utter = new SpeechSynthesisUtterance(txt.text);
        speechSynthesis.speak(utter);
        const url = '';
        setAudios([...audios, { index, provider: 'speechSynthesis', url }]);
      };

      const transcribe = async (aIndex) => {
        const audio = audios[aIndex];
        if (!audio) return;
        if (mockMode) {
          const transcript = texts[audio.index]?.text || '';
          setTranscripts([...transcripts, { aIndex, provider: 'mock', text: transcript }]);
          return;
        }
        // Real ASR not implemented; fallback copy
        const transcript = texts[audio.index]?.text || '';
        setTranscripts([...transcripts, { aIndex, provider: 'copy', text: transcript }]);
      };

      const rows = transcripts.map((t, i) => {
        const audio = audios[t.aIndex];
        const txt = texts[audio.index];
        const wer = wordErrorRate(txt.text, t.text);
        return { i: i + 1, original: txt.text, transcription: t.text, wer };
      });

      return (
        <div>
          <h1>Estonian Speech Comparison Tool</h1>
          <h2>API Key</h2>
          <input
            type="password"
            placeholder="OpenAI API key"
            value={apiKeys.openai}
            onChange={e => setApiKeys({ ...apiKeys, openai: e.target.value })}
          />
          {mockMode && <p style={{color:'red'}}>Mock mode active: no API key</p>}
          <h2>Text Generation</h2>
          <button onClick={generateText}>Generate Sample Text</button>
          <ul>
            {texts.map((t, i) => (
              <li key={i}>{t.text} <button onClick={() => synthesize(i)}>Synthesize</button></li>
            ))}
          </ul>
          <h2>Generated Audio</h2>
          <ul>
            {audios.map((a, i) => (
              <li key={i}>
                Audio {i + 1} from text {a.index + 1}
                {a.url && <audio controls src={a.url}></audio>}
                <button onClick={() => transcribe(i)}>Transcribe</button>
              </li>
            ))}
          </ul>
          <h2>Results</h2>
          <table>
            <thead>
              <tr><th>#</th><th>Original Text</th><th>Transcription</th><th>WER</th></tr>
            </thead>
            <tbody>
              {rows.map(r => (
                <tr key={r.i}>
                  <td>{r.i}</td>
                  <td>{r.original}</td>
                  <td>{r.transcription}</td>
                  <td>{r.wer}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
